deploy:
  runs-on: ubuntu-latest
  needs: [buildImageAndPush]
  steps:
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: ì¸ìŠ¤í„´ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
      id: get_instance_id
      run: |
        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=matchmyduo-ec2-1" "Name=instance-state-name,Values=running" \
          --query "Reservations[].Instances[].InstanceId" \
          --output text)
        
        echo "Found INSTANCE_ID=$INSTANCE_ID"
        
        # ë°©ì–´: ë¹„ì–´ìˆìœ¼ë©´ ì¦‰ì‹œ ì‹¤íŒ¨
        if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
          echo "INSTANCE_ID is empty. Check tag filter / region / permissions."
          exit 1
        fi
        
        # âœ… ë‹¤ìŒ stepì—ì„œ ì“°ê¸° ìœ„í•œ output
        echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"

    - name: AWS SSM Send-Command
      uses: peterkimzz/aws-ssm-send-command@master
      id: ssm
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

        # âœ… envê°€ ì•„ë‹ˆë¼ outputìœ¼ë¡œ ì£¼ì… (ê°€ì¥ ì•ˆì •ì )
        instance-ids: ${{ steps.get_instance_id.outputs.instance_id }}

        working-directory: /home/ubuntu
        comment: Deploy
        command: |
          # ë³€ìˆ˜ ì„¤ì •
          IMAGE="ghcr.io/${{ needs.buildImageAndPush.outputs.owner_lc }}/${{ needs.buildImageAndPush.outputs.image_name }}:latest"
          NETWORK="web7_9_finalscreening_be_default"
          HEALTH_ENDPOINT="/actuator/health"
          TIMEOUT=120
          
          echo "${{ secrets.MY_GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
          docker pull "$IMAGE" || { echo "âŒ ì´ë¯¸ì§€ í’€ ì‹¤íŒ¨"; exit 1; }
          
          cat <<'EOF' > /home/ubuntu/application-secret.yml
          ${{ secrets.APPLICATION_SECRET }}
          EOF
          
          if docker ps --format '{{.Ports}}' | grep -q ':8080->'; then
            CURRENT_PORT=8080
            NEXT_PORT=8081
          else
            CURRENT_PORT=8081
            NEXT_PORT=8080
          fi
          
          docker rm -f "app_$NEXT_PORT" 2>/dev/null || true
          docker run -d \
            --restart always \
            --network $NETWORK \
            --name "app_$NEXT_PORT" \
            -p "$NEXT_PORT":8080 \
            -v /home/ubuntu/application-secret.yml:/app/application-secret.yml \
            -e SPRING_PROFILES_ACTIVE=prod \
            "$IMAGE" || { echo "âŒ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"; exit 1; }
          
          echo ">>> app_$NEXT_PORT í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          START_TIME=$(date +%s)
          while true; do
            UP=$(curl -s http://localhost:$NEXT_PORT$HEALTH_ENDPOINT | grep 'UP' || true)
            if [ -n "$UP" ]; then
              echo "âœ… app_$NEXT_PORT ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. HAProxyê°€ ê³§ íŠ¸ë˜í”½ì„ ì „í™˜í•©ë‹ˆë‹¤."
              sleep 5
              break
            fi
          
            if [ $(( $(date +%s) - START_TIME )) -ge $TIMEOUT ]; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ íƒ€ì„ì•„ì›ƒ! ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤:"
              docker logs "app_$NEXT_PORT"
              docker rm -f "app_$NEXT_PORT"
              exit 1
            fi
            sleep 5
          done
          
          if command -v haproxy &> /dev/null; then
            if [ "$NEXT_PORT" == "8080" ]; then
              sudo sed -i "s/server app_server_1_1 .*/server app_server_1_1 127.0.0.1:8080 check/g" /etc/haproxy/haproxy.cfg
              sudo sed -i "s/server app_server_1_2 .*/server app_server_1_2 127.0.0.1:8081 check backup/g" /etc/haproxy/haproxy.cfg
            else
              sudo sed -i "s/server app_server_1_1 .*/server app_server_1_1 127.0.0.1:8080 check backup/g" /etc/haproxy/haproxy.cfg
              sudo sed -i "s/server app_server_1_2 .*/server app_server_1_2 127.0.0.1:8081 check/g" /etc/haproxy/haproxy.cfg
            fi
          
            sudo systemctl reload haproxy
            echo "âœ… HAProxy íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ: $NEXT_PORT"
          fi
          
          OLD_ID=$(docker ps --format '{{.ID}}\t{{.Ports}}' | awk -v p=":$CURRENT_PORT->" '$0 ~ p {print $1}' | head -n1)
          if [ -n "$OLD_ID" ]; then
            docker rm -f "$OLD_ID"
          fi
          
          docker image prune -f
          echo "ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ: app_$NEXT_PORT ê°€ ê°€ë™ ì¤‘ì…ë‹ˆë‹¤."
